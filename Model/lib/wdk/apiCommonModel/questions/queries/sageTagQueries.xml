<wdkModel>

  <querySet name="SageTagIds" queryType="id" isCacheable="false" includeProjects="EuPathDB,ToxoDB,TriTrypDB,PlasmoDB,GiardiaDB">


    <sqlQuery name="ByRStat" doNotTest="true" includeProjects="GiardiaDB,ToxoDB,TriTrypDB,PlasmoDB"
              isCacheable="true">

       <paramRef ref="geneParams.sage_tag_library_name"/>
       <paramRef ref="geneParams.sage_tag_min_r"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="R"/>
       <sql>
         <![CDATA[
       select source_id,
              '@PROJECT_ID@' as project_id, 
              to_char(sum(xij * log(10, (xij/(Ni * fj)))), '99999D0') as R
       from (
         select a.source_id, aa.library_name, library_count.n as ni, f.frequency as fj, sum(aa.raw_count) as xij
         from ApidbTuning.SageTagAnalysisAttributes aa, 
              ApidbTuning.SageTagAttributes a,
              (select a.source_id, sum(aa.raw_count) / max(n.n) as frequency
               from ApidbTuning.SageTagAnalysisAttributes aa, 
               ApidbTuning.SageTagAttributes a,
               (select sum(max(total_raw_count)) as n
                from ApidbTuning.SageTagAnalysisAttributes
                where library_name in ($$sage_tag_library_name$$)
                group by library_name) n
               where aa.library_name in ($$sage_tag_library_name$$)
                and aa.composite_element_id = a.composite_element_id
               group by a.source_id) f,
              (select library_name, max(total_raw_count) as n
               from ApidbTuning.SageTagAnalysisAttributes
               where library_name in ($$sage_tag_library_name$$)
               group by library_name) library_count
         where aa.composite_element_id = a.composite_element_id
          and a.source_id = f.source_id
          and aa.library_name = library_count.library_name
         group by a.source_id, aa.library_name, library_count.n, f.frequency
         )
       group by source_id
       having sum(xij * log(10, (xij/(Ni * fj)))) >  $$sage_tag_min_r$$
         ]]>
       </sql>
    </sqlQuery>

<processQuery name="ByRStat" includeProjects="EuPathDB" doNotTest="true" 
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

      <paramRef ref="geneParams.sage_tag_library_name" quote="false"/>
       <paramRef ref="geneParams.sage_tag_min_r"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="R"/>

 </processQuery> 



    <sqlQuery name="ByLocation" includeProjects="GiardiaDB,PlasmoDB,ToxoDB,TriTrypDB"
              isCacheable="true">
        <testParamValues includeProjects="ToxoDB">
          <paramValue name="sequenceId">TGME49_chrIa</paramValue>
        </testParamValues>
        <testParamValues includeProjects="GiardiaDB">
          <paramValue name="sequenceId">GLCHR05</paramValue>
        </testParamValues>
        <testParamValues includeProjects="PlasmoDB">
          <paramValue name="sequenceId">Pf3D7_04_v3</paramValue>
        </testParamValues>

<!--        <testParamValues includeProjects="TriTrypDB">
          <paramValue name="sequenceId">Tb927_02_v5.1</paramValue>
        </testParamValues>
-->
        <paramRef ref="sharedParams.sequenceId"/>
 <!--       <paramRef includeProjects="PlasmoDB" ref="sharedParams.chromosome"/> -->
        <paramRef ref="organismParams.organism" displayType="listBox" multiPick="false" 
                  quote="true" queryRef="organismVQ.withChromosomesSageTags"/>
      <paramRef ref="sharedParams.chromosomeOptional"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sageTagParams.is_within_gene_not"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="dynamic_location"/>

       <sql>
         <![CDATA[
            select distinct sta.source_id as source_id, '@PROJECT_ID@' as project_id,
              a.sequence_source_id || ': ' || trim(to_char(a.start_min,'999,999,999')) || ' - ' || trim(to_char(a.end_max,'999,999,999')) || decode(a.is_reversed, 1, ' (-)', ' (+)') as dynamic_location
            from ApidbTuning.SequenceAttributes satr, ApidbTuning.SageTagAttributes sta, ApidbTuning.FeatureLocation a left join ApidbTuning.SageTagGene sg
                  on a.na_feature_id = sg.tag_feature_id and sg.distance = 0 and sg.antisense = 0
            WHERE ((satr.chromosome = $$chromosomeOptional$$ and satr.organism = $$organism$$)
               OR lower(satr.source_id) = lower($$sequenceId$$))
              AND  a.na_sequence_id = satr.na_sequence_id
              AND  a.feature_type = 'SAGETagFeature'
              AND  a.end_max >=  REGEXP_REPLACE('$$start_point$$', ',| ','')
              AND  (a.start_min <=  REGEXP_REPLACE('$$end_point$$', ',| ','') OR  REGEXP_REPLACE('$$end_point$$', ',| ','') = 0)
              AND  sta.na_feature_id = a.na_feature_id
              AND (sg.gene_source_id is $$is_within_gene_not$$ null OR sg.gene_source_id is not null)
         ]]>
       </sql>
    </sqlQuery>

<processQuery name="ByLocation" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
<paramRef ref="organismParams.organism"  queryRef="organismVQ.withChromosomesSageTags" multiPick="false" noTranslation="true">
              <help>Select Organism you wish to query against.</help>
        </paramRef>
        <paramRef ref="sharedParams.chromosomeOptional"  quote="false"  noTranslation="true"/>
        <paramRef ref="sharedParams.sequenceId" default="(Example: GLCHR05)" noTranslation="true"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sageTagParams.is_within_gene_not"  quote="false"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="dynamic_location" width="100" wsName="dynamic_location"/>
  </processQuery> 


    <sqlQuery name="BySequence" includeProjects="ToxoDB,PlasmoDB,GiardiaDB,TriTrypDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.sequence"/>
        <paramRef ref="sageTagParams.is_within_gene"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id 
         from ApidbTuning.SageTagAttributes a, ApidbTuning.SageTagGene sg
         where (lower(a.sequence) = lower(replace($$sequence$$,' ')) 
                 OR lower('catg' || a.sequence) = lower($$sequence$$) )
         and a.na_feature_id = sg.tag_feature_id $$is_within_gene$$ 
         and sg.distance $$is_within_gene$$ = 0
         ]]>
       </sql>
    </sqlQuery>

<processQuery name="BySequence" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sageTagParams.sequence" noTranslation="true"/>
       <paramRef ref="sageTagParams.is_within_gene"/>
       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
  </processQuery> 

 
    <sqlQuery name="ByGeneSourceId" includeProjects="ToxoDB,PlasmoDB,GiardiaDB,TriTrypDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.single_gene_id"/>
        <paramRef ref="geneParams.st_max_five_prime_distance"/>
        <paramRef ref="geneParams.st_max_three_prime_distance"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id
         from ApidbTuning.SageTagAttributes a, ApidbTuning.SageTagGene sg
         where a.na_feature_id = sg.tag_feature_id
         and sg.antisense = 0
         and sg.gene_source_id LIKE REGEXP_REPLACE(REPLACE($$single_gene_id$$,'*', '%'),'[[:space:]]', '')
         and ((sg.direction = '5' and sg.distance <= $$st_max_five_prime_distance$$)
             OR (sg.direction = '3' and sg.distance <= $$st_max_three_prime_distance$$))
         ]]>
       </sql>
</sqlQuery>


 
<processQuery name="ByGeneSourceId" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

       <paramRef ref="sageTagParams.single_gene_id" noTranslation="true"/>
       <paramRef ref="geneParams.st_max_five_prime_distance"/>
       <paramRef ref="geneParams.st_max_three_prime_distance"/>
      
       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
   </processQuery> 

  
 <sqlQuery name="ByRadSourceId" doNotTest="true" includeProjects="GiardiaDB,TriTrypDB,PlasmoDB,ToxoDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.rad_source_id"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id
         from ApidbTuning.SageTagAttributes a, ($$rad_source_id$$) ds
         where a.rad_source_id LIKE REGEXP_REPLACE(REPLACE(ds.source_id,'*', '%'),'[[:space:]]', '') 
            or a.source_id LIKE REGEXP_REPLACE(REPLACE(ds.source_id,'*', '%'),'[[:space:]]', '')
         ]]>
       </sql>
</sqlQuery>

 <processQuery name="ByRadSourceId" includeProjects="EuPathDB" doNotTest="true"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sageTagParams.rad_source_id" noTranslation="true"/>
       <paramRef ref="sharedParams.wdk_user_signature" noTranslation="true"/>
       <wsColumn name="source_id" width="320" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
   </processQuery> 


 <sqlQuery name="ByExpressionLevel" includeProjects="ToxoDB,TriTrypDB,PlasmoDB,GiardiaDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.st_min_count"/>
        <paramRef ref="sageTagParams.raw_normalized"/>
        <paramRef ref="sageTagParams.sage_experiment"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="tag_count" />
        <column name="tag_percentage" />
        <column name="raw_count" />
        <column name="raw_percentage" />
        <column name="SAGE_library" />
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id,to_char(staa.tag_count, '99999') as tag_count, to_char(staa.raw_count , '99999') as raw_count,
         to_char(staa.library_tag_percentage,'990D00') || '%' as tag_percentage,
         to_char(staa.raw_percent,'990D00') || '%' as raw_percentage,
         staa.library_name as SAGE_library
         from ApidbTuning.SageTagAttributes a, ApidbTuning.SageTagAnalysisAttributes staa
         where (CASE '$$raw_normalized$$' WHEN 'n' THEN staa.tag_count ELSE staa.raw_count END)>= $$st_min_count$$ 
         and staa.library_name = $$sage_experiment$$
         and a.composite_element_id=staa.composite_element_id
         ]]>
       </sql>
</sqlQuery>

<processQuery name="ByExpressionLevel" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

       <paramRef ref="sageTagParams.st_min_count"/>
       <paramRef ref="sageTagParams.raw_normalized"/>
       <paramRef ref="sageTagParams.sage_experiment" quote="false"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>

       <wsColumn name="tag_count" width="32" wsName="tag_count" />
       <wsColumn name="tag_percentage" width="32" wsName="tag_percentage"/>
       <wsColumn name="raw_count" width="32" wsName="raw_count"/>
       <wsColumn name="raw_percentage" width="32" wsName="raw_percentage"/>
       <wsColumn name="SAGE_library" width="100" wsName="SAGE_library"/>
   </processQuery>

    
    
    <sqlQuery name="ByWeightFilter" isCacheable="true" doNotTest="true">
        <paramRef ref="sageTagParams.sageTag_result"/>
        <paramRef ref="sharedParams.min_weight" default="0"/>
        <paramRef ref="sharedParams.max_weight" default="100"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="wdk_weight" />
        <sql>
            <![CDATA[
            SELECT a.source_id, a.project_id, a.wdk_weight
            FROM $$sageTag_result$$ a
            WHERE a.wdk_weight >= $$min_weight$$
              AND a.wdk_weight <= $$max_weight$$
            ]]>
       </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
