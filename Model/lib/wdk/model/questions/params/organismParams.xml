<wdkModel>

  <constant name="maxRecommendedOrganisms">5</constant>
  <!-- note: if you change the 5 above you must change two "five"s below -->
  <constant name="maxRecommendedMessage"><![CDATA[
        <p>
          You are selecting more than five organisms.
        </p>
        <p>
          Selecting a large number of organisms may impact performance and make results harder to interpret.
        </p>
        <p>
          <b>Please select five or fewer organisms where possible.</b>
        </p>
        <p>
          For the best experience, use <i>My Organism Preferences</i> in the page header to focus on the organisms you care about most.
        </p>
]]></constant>


  <!--=====================================================================-->
  <!-- Params  -->
  <!--=====================================================================-->
  <paramSet name="organismParams">

    <stringParam name="organismSite" visible="false" number="false">
    </stringParam>

    <!-- UNUSED, keep as an example

     <stringParam name="hiddenOrganismGiardia" visible="false">
           </stringParam>

    -->

<!--
      <enumParam name="reference_strains_only"
                 prompt="Reference strains only"
                 multiPick="false"
                 quote="false">
        <noTranslation value="true" includeProjects="EuPathDB" />
        <help>
           Choose whether to include only organisms that are reference organisms for each species.
        </help>
        <enumList>
          <enumValue>
            <term>Yes</term>
            <internal>1</internal>
          </enumValue>
          <enumValue default="true">
            <term>No</term>
            <internal>1,0</internal>
          </enumValue>
        </enumList>
      </enumParam>
-->

        <flatVocabParam name="organism"
                     queryRef="organismVQ.withGenes"
                     prompt="Organism"
                     displayType="treeBox"
                     multiPick="true"
                     suppressNode="true"
                     quote="true">

         <suggest selectMode="none"/>
          <help>
               Select organism(s) you wish to query against. Click the [+] to expand taxon groupings.
          </help>

          <propertyList name="organismProperties">
            <value>pruneNodesWithSingleExtendingChild</value>
            <value>showOnlyPreferredOrganisms</value>
            <value>highlightReferenceOrganisms</value>
          </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
        </flatVocabParam>
<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++-->

	<flatVocabParam name="organism_span"
                     queryRef="organismVQ.withIntronJunctions"
                     prompt="Organism"
                     displayType="treeBox"
                     multiPick="true"
                     suppressNode="true"
                     quote="true">

         <suggest selectMode="none"/>
          <help>
               Select organism(s) you wish to query against. Click the [+] to expand taxon groupings.
          </help>

          <propertyList name="organismProperties">
            <value>pruneNodesWithSingleExtendingChild</value>
            <value>showOnlyPreferredOrganisms</value>
            <value>highlightReferenceOrganisms</value>
          </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
        </flatVocabParam>

<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <flatVocabParam name="organism_select_all" minSelectedCount="1"
                     queryRef="organismVQ.withGenes"
                     prompt="Organism"
                     displayType="treeBox"
                     multiPick="true"
                     suppressNode="true"
                     
                     quote="true">

         <suggest selectMode="all"/>
          <help>
               Select organism(s) you wish to query against. Click the [+] to expand taxon groupings.
          </help>

          <propertyList name="organismProperties">
            <value>pruneNodesWithSingleExtendingChild</value>
            <value>showOnlyPreferredOrganisms</value>
            <value>highlightReferenceOrganisms</value>
          </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
        </flatVocabParam>

        <flatVocabParam name="organism_select_all"
                     queryRef="organismVQ.withGenes"
                     prompt="Organism"
                     displayType="treeBox"
                     multiPick="true"
                     suppressNode="true"
                     includeProjects="EuPathDB"
                     quote="true">

         <suggest selectMode="all"/>
          <help>
               Select organism(s) you wish to query against. Click the [+] to expand taxon groupings.
          </help>

          <propertyList name="organismProperties">
            <value>pruneNodesWithSingleExtendingChild</value>
            <value>showOnlyPreferredOrganisms</value>
            <value>highlightReferenceOrganisms</value>
          </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
        </flatVocabParam>



<!-- organism_select_all_sequences is to get ALL orgs, not just the annotated ones -->
        <flatVocabParam name="organism_select_all_sequences" minSelectedCount="1"
                     queryRef="organismVQ.withSequenceStrains"
                     prompt="Organism"
                     displayType="treeBox"
                     multiPick="true"
                     suppressNode="true"
                     
                     quote="true">
         <suggest selectMode="all"/>
          <help>
               Select organism(s) you wish to query against. Click the [+] to expand taxon groupings.
          </help>
          <propertyList name="organismProperties">
            <value>highlightReferenceOrganisms</value>
          </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
        </flatVocabParam>

        <flatVocabParam name="organism_select_all_sequences"
                     queryRef="organismVQ.withSequenceStrains"
                     prompt="Organism"
                     displayType="treeBox"
                     multiPick="true"
                     suppressNode="true"
                     includeProjects="EuPathDB"
                     quote="true">
         <suggest selectMode="all"/>
          <help>
               Select organism(s) you wish to query against. Click the [+] to expand taxon groupings.
          </help>
          <propertyList name="organismProperties">
            <value>pruneNodesWithSingleExtendingChild</value>
            <value>showOnlyPreferredOrganisms</value>
            <value>highlightReferenceOrganisms</value>
          </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
        </flatVocabParam>


    <flatVocabParam name="organismwithPhenotype"
                    queryRef="organismVQ.withPhenotype"
                    prompt="Organism"
                    multiPick="false"
                    quote="false"
                    includeProjects="TriTrypDB,FungiDB,EuPathDB,UniDB">
      <help>
        Select organisms you wish to query against.
      </help>

    </flatVocabParam>

    <flatVocabParam name="organismSinglePickCnv"
                    queryRef="organismVQ.CNV"
                    prompt="Organism"
                    multiPick="false"
                    quote="true"
                    includeProjects="AmoebaDB,CryptoDB,PlasmoDB,ToxoDB,TriTrypDB,FungiDB,UniDB">
      <noTranslation value="true"/>
      <help>
        Select the organism you wish to query against.
      </help>
      <suggest includeProjects="CryptoDB" default="Cryptosporidium parvum Iowa II"/>
      <suggest includeProjects="PlasmoDB" default="Plasmodium falciparum 3D7"/>
      <suggest includeProjects="ToxoDB" default="Toxoplasma gondii ME49"/>
      <suggest includeProjects="TriTrypDB" default="Leishmania infantum JPCM5"/>
      <propertyList name="organismProperties">
        <value>showOnlyPreferredOrganisms</value>
      </propertyList>
    </flatVocabParam>

        <flatVocabParam name="organismSinglePick"
                      queryRef="organismVQ.withGenes"
                      prompt="Organism"
                      displayType="treeBox"
                      maxSelectedCount="1"
                      multiPick="true"
                      quote="true"
                     suppressNode="false">
           <suggest default="%%primaryOrthoOrganism%%"/>
           <help>
               Select the organism you wish to query against.
           </help>
          <propertyList name="organismProperties">
            <value>pruneNodesWithSingleExtendingChild</value>
            <value>showOnlyPreferredOrganisms</value>
            <value>highlightReferenceOrganisms</value>
          </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
        </flatVocabParam>

    <flatVocabParam name="gff_organism"
                    queryRef="organismVQ.withGenesGFF"
                    prompt="Organism"
                    multiPick="true"
                    quote="true">
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
    </flatVocabParam>

    <!-- same query as withSequenceStrains but internal is term -->
    <flatVocabParam name="text_search_organism"
                    queryRef="organismVQ.forTextSearch"
                    prompt="Organism"
                    displayType="treeBox"
                    multiPick="true"
                    quote="false"
                    suppressNode="true">
      <suggest selectMode="none"/>
      <help>
        Select the organism(s) you wish to query against. Click the [+] to expand taxon groupings.
      </help>
      <propertyList name="organismProperties">
        <value>pruneNodesWithSingleExtendingChild</value>
        <value>showOnlyPreferredOrganisms</value>
        <value>highlightReferenceOrganisms</value>
      </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
    </flatVocabParam>

        <flatVocabParam name="org_with_nonnuclear_genes" includeProjects="AmoebaDB,PlasmoDB,ToxoDB,EuPathDB,FungiDB,HostDB,PiroplasmaDB,VectorBase,UniDB"
			queryRef="organismVQ.OrgsWithNonNuclearGenes"
			prompt="Organism">
 	  <help>
	    Select the organism(s) you wish to query.
	  </help>
        </flatVocabParam>

    <flatVocabParam name="org_with_centromere_genes" includeProjects="PlasmoDB,ToxoDB,TriTrypDB,EuPathDB,UniDB"
                    queryRef="organismVQ.OrgsWithCentromereGenes"
                    prompt="Organism">
      <help>
        Select the organism(s) you wish to query.
      </help>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
    </flatVocabParam>

    <flatVocabParam name="org_with_Hagai_pathways" includeProjects="PlasmoDB,ToxoDB,EuPathDB,UniDB"
                    queryRef="organismVQ.OrgsWithHagaiPathways"
                    prompt="Organism">
      <help>
        Select the organism(s) you wish to query.
      </help>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
    </flatVocabParam>


    <flatVocabParam name="organismWithCellularLocImages"
                    queryRef="organismVQ.withCellularLocImages"
                    prompt="Organism"
                    multiPick="false"
                    quote="true"
                    includeProjects="TriTrypDB,GiardiaDB,EuPathDB,UniDB">
      <help>
        Select organisms you wish to query against.
      </help>
    </flatVocabParam>

    <flatVocabParam name="organismsWithAlphafold"
                    queryRef="organismVQ.WithAlphaFold"
                    prompt="Organism"
                    multiPick="true"
                    suppressNode="true"
                    displayType="treeBox"
                    quote="true">

      <suggest selectMode="none"/>

      <help>
        Select the organism(s) you with to query.
      </help>

      <propertyList name="organismProperties">
        <value>showOnlyPreferredOrganisms</value>
      </propertyList>
          <propertyList name="maxRecommended">
            <value>%%maxRecommendedOrganisms%%</value>
          </propertyList>
          <propertyList name="maxRecommendedMsg">
            <value><![CDATA[%%maxRecommendedMessage%%]]></value>
          </propertyList>
    </flatVocabParam>

    <flatVocabParam name="organismsWithSingleCell" includeProjects="TriTrypDB,PlasmoDB,PiroplasmaDB,ToxoDB,HostDB,CryptoDB,UniDB"
        queryRef="organismVQ.WithSingleCell"
        prompt="Organism"
        multiPick="false"
        quote="true">

      <help>
        Select the organism you wish to query against.
      </help>
    </flatVocabParam>


    <!--=====================================================================-->
    <!-- organismWithEstsInChromosomes: I think it is not being used     -->
    <!--=====================================================================-->

    <enumParam name="organismWithEstsInChromosomes"
               prompt="Organism"
               multiPick="false"
               includeProjects="PlasmoDB,EuPathDB,UniDB" >
      <noTranslation value="true" includeProjects="EuPathDB" />
      <enumList>
        <enumValue includeProjects="PlasmoDB,EuPathDB,UniDB">
          <term>Plasmodium falciparum</term>
          <internal>Plasmodium falciparum 3D7</internal>
        </enumValue>
        <enumValue includeProjects="PlasmoDB,EuPathDB,UniDB">
          <term>Plasmodium vivax</term>
          <internal>Plasmodium vivax Sal-1</internal>
        </enumValue>

      </enumList>
    </enumParam>


    <enumParam name="organismWithLopitData"
                     prompt="Organism"
                     multiPick="false"
                     includeProjects="ToxoDB,TriTrypDB,UniDB" >
      <noTranslation value="true" includeProjects="EuPathDB" />
      <enumList>
        <enumValue includeProjects="ToxoDB,EuPathDB,UniDB">
          <term>Toxoplasma gondii ME49</term>
          <internal>Toxoplasma gondii ME49</internal>
        </enumValue>
        <enumValue includeProjects="TriTrypDB,EuPathDB,UniDB">
          <term>Trypanosoma brucei brucei TREU927</term>
          <internal>Trypanosoma brucei brucei TREU927</internal>
        </enumValue>
        <enumValue includeProjects="TriTrypDB,EuPathDB,UniDB">
          <term>Trypanosoma congolense IL3000</term>
          <internal>Trypanosoma congolense IL3000</internal>
        </enumValue>
      </enumList>
    </enumParam>

  </paramSet>


  <!--=====================================================================-->
  <!-- Vocab queries for organism parameters

       These queries differ by which rows they return.  The columns are the
       same:

         term: scientific name of species
         internal: comma-separated list of all taxon ids for the clade whose
                   root is that species

        Many have the same general structure:
         - the taxon list which forms the internal value us generated by a
           recursive sub-query nested inside the SELECT clause
         - the set of rows is determined by an inline view in the FROM clause
           named "organisms"
         - an optional ordering is imposed by another inline view in the FROM
           clause named "partial_ordering".  This is used to let
           P. falciparum, P. vivax, and P. yoelii (in that order) start a
           list of genes.  It's OK for any (or all) of those to be omitted
           from the list, and it's OK for other genes to be included, but if
           they're there, they go first. Otherwise, the organisms are
           ordered alphabetically.
                                                                           -->
  <!--=====================================================================-->

  <querySet name="organismVQ" queryType="vocab" isCacheable="true">



    <!--===================================================================-->
    <!-- intron junctions query -->
    <!--===================================================================-->
    <sqlQuery name="withIntronJunctions" >
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
      <sql>
        WITH FilterQuery AS (
          SELECT DISTINCT ga.organism, ga.org_abbrev
          FROM webready.geneintronjunction_p gij, apidbtuning.GeneAttributes ga
          WHERE ga.source_id = gij.gene_source_id
        )
        /* end filter query */
        SELECT DISTINCT term, parentTerm, string_agg(trim(fq.org_abbrev), ', ') AS internal
        FROM ApidbTuning.OrganismTree ot, FilterQuery fq
        WHERE ot.organism = fq.organism
        GROUP BY term, parentTerm
        ORDER BY parentTerm,term
      </sql>
    </sqlQuery>





    <!--===================================================================-->
    <!-- with chromosomes -->
    <!--===================================================================-->

    <sqlQuery name="withChromosomes" excludeProjects="SchistoDB,EuPathDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        SELECT DISTINCT ta.organism AS term, ta.org_abbrev AS internal
        FROM apidbtuning.TranscriptAttributes ta, apidb.organism o
        WHERE ta.chromosome IS NOT NULL
          AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          AND ta.taxon_id = o.taxon_id
        ORDER BY term
      </sql>
    </sqlQuery>



    <!-- CNV -->

    <sqlQuery name="CNV" includeProjects="AmoebaDB,CryptoDB,PlasmoDB,ToxoDB,TriTrypDB,FungiDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        SELECT DISTINCT tn.NAME as term
          , string_agg(o.abbrev, ',') as internal
        FROM APIDB.DATASOURCE d
          , SRES.TAXONNAME tn
          , SRES.EXTERNALDATABASE ed
          , SRES.EXTERNALDATABASERELEASE edr
          , STUDY.nodeset s1
	  , apidb.organism o
        WHERE lower(d.NAME) like '%copynumbervariations_%'
          AND tn.TAXON_ID = d.TAXON_ID
	  AND tn.taxon_id = o.taxon_id
          AND tn.NAME_CLASS = 'scientific name'
          AND ed.name = d.name
          AND edr.VERSION = d.VERSION
          AND edr.EXTERNAL_DATABASE_ID = ed.EXTERNAL_DATABASE_ID
          AND s1.EXTERNAL_DATABASE_RELEASE_ID = edr.EXTERNAL_DATABASE_RELEASE_ID
        GROUP BY tn.name
        ORDER BY tn.NAME
      </sql>
    </sqlQuery>


    <!--===================================================================-->
    <!-- with chromosomes and SNPs -->
    <!--===================================================================-->

    <sqlQuery name="withNgsSNPs" excludeProjects="EuPathDB,HostDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        WITH FilterQuery as (
          SELECT distinct ta.organism
          FROM apidbtuning.TranscriptAttributes ta, apidb.organism o
          WHERE ta.taxon_id = o.taxon_id
          AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
        )
        SELECT s.organism as term, s.organism as internal
        FROM apidbtuning.snpstrains s, FilterQuery fq
        WHERE s.organism = fq.organism
        ORDER BY s.organism
      </sql>
    </sqlQuery>


    <sqlQuery name="withNgsSNPsTree" >
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
        <sql>
         WITH FilterQuery as (
             select distinct ta.organism, ta.project_id, ta.org_abbrev
             from apidbtuning.snpstrains ss, apidbtuning.TranscriptAttributes ta, apidb.organism o
             where ta.taxon_id = o.taxon_id
             and ss.organism = ta.organism
             and (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            )
         SELECT DISTINCT term, parentTerm,
           CASE WHEN term = ot.organism THEN term ELSE '-1' END AS internal
         FROM ApidbTuning.OrganismTree ot, FilterQuery fq
         WHERE ot.organism = fq.organism
         GROUP BY term, parentTerm, ot.organism
         ORDER BY parentTerm, term
        </sql>
        </sqlQuery>


    <!--=======================-->
    <!-- with NGS SNP datasets -->
    <!--=======================-->

    <sqlQuery name="withNgsSNPdatasets" includeProjects="AmoebaDB,CryptoDB,FungiDB,MicrosporidiaDB,PiroplasmaDB,PlasmoDB,TriTrypDB,ToxoDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        SELECT DISTINCT organism as term, organism as internal
        FROM apidbTuning.Ontology
        WHERE dataset_subtype = 'HTS_SNP'
        ORDER BY organism
      </sql>
    </sqlQuery>

    <!-- ======================================================== -->
    <!-- ======================================================== -->
    <!-- ======= All SNP params below here might be obsolete  === -->
    <!-- ======================================================== -->
    <!-- ======================================================== -->

    <sqlQuery name="withChromosomesSNPs" includeProjects="PlasmoDB,UniDB">
      <column name="internal"/>
      <column name="term"/>

      <sql>
        SELECT sa.organism as term, sa.organism as internal,count(s.strain) as strain_count
        FROM apidbtuning.snpchipstrains s, apidbtuning.GenomicSeqAttributes sa, apidb.organism o
        WHERE sa.organism = s.organism
          AND sa.chromosome is not null
          AND (sa.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          AND sa.taxon_id = o.taxon_id
        GROUP BY sa.organism
        ORDER BY strain_count desc
      </sql>
    </sqlQuery>



    <sqlQuery name="withChromosomesHtsSNPs" excludeProjects="EuPathDB,AmoebaDB,HostDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        SELECT sa.organism as term, sa.organism as internal,count(s.strain) as strain_count
        FROM apidbtuning.snpstrains s, apidbtuning.GenomicSeqAttributes sa
        WHERE sa.organism = s.organism
          AND sa.chromosome is not null
          AND (sa.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
        GROUP BY sa.organism
        ORDER BY strain_count desc
      </sql>
    </sqlQuery>



    <sqlQuery name="withSNPs" includeProjects="PlasmoDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        SELECT CASE WHEN s.organism like '%strain CL Brener%' THEN 'Trypanosoma cruzi strain CL Brener - Unassigned' ELSE s.organism END as term,
          s.organism as internal
        FROM apidbtuning.snpchipstrains s
        AND (s.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
        GROUP BY s.organism
      </sql>
    </sqlQuery>


    <!--===================================================================-->
    <!-- with genes

         Each row returned represents a species.  Species are only included if
         they are represented in a sequence record (in dots.NaSequence), either
         by their own taxon_id or that of a subspecies.  Sequence records are
         only used if there is a gene record (dots.GeneFeature) that points to
         them.
                                                                           -->
    <!--===================================================================-->
    <sqlQuery name="withGenes" isCacheable="true" >
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
      <sql>
        <![CDATA[
          /* WithGenes filter query*/
          WITH FilterQuery as (
            SELECT distinct tn.name as organism, o.abbrev
            FROM sres.taxonName tn, apidb.organism o
            WHERE o.is_annotated_genome = 1
              AND (o.project_name = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
              AND o.taxon_id = tn.taxon_id
              AND tn.name_class = 'scientific name'
          )
          /* end filter query */
          SELECT DISTINCT term, parentTerm, string_agg(fq.abbrev, ', ') AS internal
          FROM ApidbTuning.OrganismTree ot, FilterQuery fq
          WHERE ot.organism = fq.organism
          GROUP BY term, parentTerm
          ORDER BY parentTerm,term
        ]]>
      </sql>
    </sqlQuery>

    <!-- Same as legacy text search but internal values are actual organism names, not numerical codes -->
    <sqlQuery name="forGeneTextSearch" isCacheable="true" >
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
      <sql>
        <![CDATA[
          /* WithGenes filter query*/
          WITH FilterQuery as (
            SELECT distinct tn.name as organism
            FROM sres.taxonName tn, apidb.organism o
            WHERE o.is_annotated_genome = 1
              AND (o.project_name = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
              AND o.taxon_id = tn.taxon_id
              AND tn.name_class = 'scientific name'
          )
          /* end filter query */
          SELECT DISTINCT term, parentTerm, term AS internal
          FROM ApidbTuning.OrganismTree ot, FilterQuery fq
          WHERE ot.organism = fq.organism
          GROUP BY term, parentTerm
          ORDER BY parentTerm,term
        ]]>
      </sql>
    </sqlQuery>



    <sqlQuery name="forTextSearch" isCacheable="true" >
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
      <sql>
        <![CDATA[
          /* withSequenceStrains filter query */
          WITH FilterQuery AS (
            SELECT DISTINCT sa.organism
            FROM apidbtuning.GenomicSeqAttributes sa, apidb.organism o
            WHERE sa.taxon_id = o.taxon_id
              AND (sa.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            )
             /* end filter query */
          SELECT DISTINCT term, parentTerm, term AS internal
          FROM ApidbTuning.OrganismTree ot, FilterQuery fq
          WHERE ot.organism = fq.organism
          GROUP BY term, parentTerm
        ]]>
      </sql>
    </sqlQuery>



    <!--===================================================================-->
    <!-- with genes with epitopes    -->
    <!--===================================================================-->

    <sqlQuery name="withEpitopes"  includeProjects="AmoebaDB,CryptoDB,ToxoDB,PlasmoDB,GiardiaDB,TrichDB,TriTrypDB,PiroplasmaDB,FungiDB,VectorBase,MicrosporidiaDB,UniDB" isCacheable="true">
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
      <sql>
        <![CDATA[
	WITH FilterQuery AS (
            SELECT DISTINCT ta.organism, ta.org_abbrev
              FROM apidbtuning.TranscriptAttributes ta, apidb.aasequenceepitope ae
              WHERE ta.aa_sequence_id = ae.aa_sequence_id
              AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          )
          /* end filter query */
          SELECT DISTINCT term, parentTerm
          , string_agg(fq.org_abbrev, ', ') AS internal
          FROM ApidbTuning.OrganismTree ot, FilterQuery fq
          WHERE ot.organism = fq.organism
          GROUP BY term, parentTerm
          ORDER BY parentTerm,term
        ]]>
      </sql>
    </sqlQuery>


    <!--===================================================================-->
    <!-- with sequencestrains, only used by Toxo
         Toxo should use organismVQ.withGenomicSeq instead like everybody
         we do not change to not make incompatible queries     -->
    <!--===================================================================-->


    <sqlQuery name="withSequenceStrains" >
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
      <sql>
        <![CDATA[
          /* withSequenceStrains filter query */
          WITH FilterQuery AS (
            SELECT DISTINCT sa.organism, o.abbrev
            FROM apidbtuning.GenomicSeqAttributes sa, apidb.organism o
            WHERE sa.taxon_id = o.taxon_id
              AND (sa.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          )
          /* end filter query */
          SELECT DISTINCT term, parentTerm, string_agg(fq.abbrev, ', ')
              AS internal
          FROM ApidbTuning.OrganismTree ot, FilterQuery fq
          WHERE ot.organism = fq.organism
          GROUP BY term, parentTerm
          ORDER BY parentTerm, term
        ]]>
      </sql>
    </sqlQuery>


    <!--===================================================================-->
    <!-- with sequencestrains, only used by
         Toxo should use organismVQ.withGenomicSeq instead like everybody
         we do not change to not make incompatible queries     -->
    <!--===================================================================-->


    <sqlQuery name="withStrainsChromosome"
              includeProjects="TriTrypDB,ToxoDB,PlasmoDB,MicrosporidiaDB,CryptoDB,PiroplasmaDB,FungiDB,GiardiaDB,VectorBase,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT distinct sa.organism as term, sa.org_abbrev as internal
          FROM apidbtuning.GenomicSeqAttributes sa, apidb.organism o
          WHERE sa.chromosome IS NOT NULL
            AND (sa.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            AND sa.taxon_id = o.taxon_id
          ORDER BY sa.organism asc
        ]]>
      </sql>
    </sqlQuery>


    <!--===================================================================-->
    <!-- only in TriTrypDB and Portal: genes based on phenotype    -->
    <!--===================================================================-->

    <sqlQuery name="withPhenotype_TriTryp" includeProjects="TriTrypDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT DISTINCT ta.organism as term
             , ta.org_abbrev as internal
          FROM apidbtuning.TranscriptAttributes ta, Apidb.phenotypemodel pm ,Apidb.phenotyperesult pr, APIDB.NAFEATUREPHENOTYPEMODEL na
          WHERE ta.gene_na_feature_id = na.na_feature_id
            AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            AND pm.phenotype_model_id = na.PHENOTYPE_MODEL_ID
            AND pm.phenotype_model_id = pr.phenotype_model_id
            AND pr.PHENOTYPE_ENTITY_TERM_ID is not null
            AND ta.project_id = 'TriTrypDB'
          ORDER BY term
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="withPhenotype" includeProjects="TriTrypDB,FungiDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT DISTINCT ta.organism as term
             , ta.org_abbrev as internal
          FROM apidbtuning.TranscriptAttributes ta, Apidb.phenotypemodel pm ,Apidb.phenotyperesult pr, APIDB.NAFEATUREPHENOTYPEMODEL na
          WHERE ta.gene_na_feature_id = na.na_feature_id
            AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            AND pm.phenotype_model_id = na.PHENOTYPE_MODEL_ID
            AND pm.phenotype_model_id = pr.phenotype_model_id
            AND pr.PHENOTYPE_ENTITY_TERM_ID is not null
          ORDER BY term
        ]]>
      </sql>
    </sqlQuery>



    <sqlQuery name="withPhenotype_phenotype_QIAGEN_RSRC" includeProjects="FungiDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT DISTINCT ta.organism as term
             , ta.org_abbrev as internal
          FROM apidbtuning.TranscriptAttributes ta, Apidb.phenotypemodel pm ,Apidb.phenotyperesult pr, APIDB.NAFEATUREPHENOTYPEMODEL na
          WHERE ta.gene_na_feature_id = na.na_feature_id
            AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            AND pm.phenotype_model_id = na.PHENOTYPE_MODEL_ID
            AND pm.phenotype_model_id = pr.phenotype_model_id
            AND pr.PHENOTYPE_ENTITY_TERM_ID is not null
            AND ta.organism like 'Cry%'
          ORDER BY term
        ]]>
      </sql>
    </sqlQuery>



    <!-- for manually curated phenotypes in FungiDB -->
    <sqlQuery name="withPhenotype_phenotype_DATA_RSRC" includeProjects="FungiDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT DISTINCT ta.organism as term
             , ta.org_abbrev as internal
          FROM apidbtuning.TranscriptAttributes ta, Apidb.phenotypemodel pm ,Apidb.phenotyperesult pr, APIDB.NAFEATUREPHENOTYPEMODEL na
                 , sres.externaldatabase d, sres.externaldatabaserelease r
          WHERE ta.gene_na_feature_id = na.na_feature_id
            AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            AND pm.phenotype_model_id = na.PHENOTYPE_MODEL_ID
            AND pm.phenotype_model_id = pr.phenotype_model_id
            AND pr.PHENOTYPE_ENTITY_TERM_ID is not null
            AND pm.external_database_release_id = r.external_database_release_id
            AND r.external_database_id = d.external_database_id
            AND d.name like '%_phenotype_VEuPathDB_curated_phenotype_RSRC'
          ORDER BY term
        ]]>
      </sql>
    </sqlQuery>




    <!-- for manually curated phenotypes in FungiDB -->
    <sqlQuery name="withPhenotype_phenotype_Magnaporthe_Pheno_RSRC" includeProjects="FungiDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT DISTINCT ta.organism as term
             , ta.org_abbrev as internal
          FROM apidbtuning.TranscriptAttributes ta, Apidb.phenotypemodel pm ,Apidb.phenotyperesult pr, APIDB.NAFEATUREPHENOTYPEMODEL na
                 , sres.externaldatabase d, sres.externaldatabaserelease r
          WHERE ta.gene_na_feature_id = na.na_feature_id
            AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            AND pm.phenotype_model_id = na.PHENOTYPE_MODEL_ID
            AND pm.phenotype_model_id = pr.phenotype_model_id
            AND pr.PHENOTYPE_ENTITY_TERM_ID is not null
            AND pm.external_database_release_id = r.external_database_release_id
            AND r.external_database_id = d.external_database_id
            AND d.name like 'mory70-15_phenotype_Magnaporthe_Pheno_RSRC'
          ORDER BY term
        ]]>
      </sql>
    </sqlQuery>


    <sqlQuery name="withPhenotype_fgraPH-1_phenotype_Fusarium_Pheno_RSRC" includeProjects="FungiDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
	      SELECT DISTINCT ta.organism as term
               , ta.org_abbrev as internal
          FROM apidbtuning.TranscriptAttributes ta, Apidb.phenotypemodel pm ,Apidb.phenotyperesult pr, APIDB.NAFEATUREPHENOTYPEMODEL na
          WHERE ta.gene_na_feature_id = na.na_feature_id
	        AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
	        AND pm.phenotype_model_id = na.PHENOTYPE_MODEL_ID
	        AND pm.phenotype_model_id = pr.phenotype_model_id
            AND pr.PHENOTYPE_ENTITY_TERM_ID is not null
            AND ta.organism like 'Fus%'
          ORDER BY term
        ]]>
      </sql>
    </sqlQuery>


    <sqlQuery name="withPhenotype_mory70-15_phenotype_Magnaporthe_Pheno_RSRC" includeProjects="FungiDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT DISTINCT ta.organism as term
            , ta.org_abbrev as internal
          FROM apidbtuning.TranscriptAttributes ta, Apidb.phenotypemodel pm ,Apidb.phenotyperesult pr, APIDB.NAFEATUREPHENOTYPEMODEL na
          WHERE ta.gene_na_feature_id = na.na_feature_id
            AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
            AND pm.phenotype_model_id = na.PHENOTYPE_MODEL_ID
            AND pm.phenotype_model_id = pr.phenotype_model_id
            AND pr.PHENOTYPE_ENTITY_TERM_ID is not null
            AND ta.organism like 'Pyriculari%'
          ORDER BY term
        ]]>
      </sql>
    </sqlQuery>



    <!--===================================================================-->
    <!-- used in other recordtype queries (other than gene) for dumping    -->
    <!--===================================================================-->


    <sqlQuery name="withGenesGFF" >
      <column name="internal"/>
      <column name="term"/>

      <sql>
        <![CDATA[
          SELECT distinct ga.organism as term, ga.org_abbrev as internal
          FROM apidbtuning.GeneAttributes ga
          WHERE (ga.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          ORDER BY organism asc
        ]]>
      </sql>
    </sqlQuery>


    <!--===================================================================-->
    <!-- with EC Number -->
    <!--===================================================================-->
    <sqlQuery name="withEC" excludeProjects="MicrospordiaDB,EuPathDB" isCacheable="true">
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
      <sql>
        <![CDATA[
          WITH FilterQuery AS (
            SELECT DISTINCT ta.organism, ta.org_abbrev
            FROM apidbtuning.TranscriptAttributes ta
            LEFT JOIN webready.TranscriptOrthologGroup tog on ta.source_id = tog.source_id
            WHERE (ta.ec_numbers IS NOT NULL OR tog.ec_numbers_derived IS NOT NULL)
              AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          )
          /* end filter query */
          SELECT DISTINCT term, parentTerm
            , string_agg(org_abbrev, ', ') AS internal
          FROM ApidbTuning.OrganismTree ot, FilterQuery fq
          WHERE ot.organism = fq.organism
          GROUP BY term, parentTerm
          ORDER BY parentTerm,term
        ]]>
      </sql>
    </sqlQuery>

    <!--===================================================================-->
    <!-- with tfBindingSite -->
    <!--===================================================================-->

    <sqlQuery name="tfBindingSite" includeProjects="PlasmoDB,UniDB" isCacheable="true">
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>
      <sql>
        <![CDATA[
          /* tfBindingSite filter query */
          WITH FilterQuery AS (
            SELECT DISTINCT ga.organism, ga.org_abbrev
            FROM apidbtuning.GeneAttributes ga, webready.TFBSGene_p tg
            WHERE tg.gene_source_id = ga.source_id
              AND (ga.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          )
          SELECT DISTINCT term, parentTerm
            , string_agg(fq.org_abbrev, ', ') AS internal
          FROM ApidbTuning.OrganismTree ot, FilterQuery fq, Sres.TaxonName tn
          WHERE ot.organism = fq.organism
            AND tn.taxon_id = ot.internal
            AND tn.name_class = 'scientific name'
          GROUP BY term, parentTerm
          ORDER BY parentTerm,term
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="WithAlphaFold"  isCacheable="true">
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>

      <sql>
        <![CDATA[
          --alphafold filter query
          WITH FilterQuery AS (
            SELECT DISTINCT ga.organism, ga.org_abbrev
            FROM apidbtuning.GeneAttributes ga
              , webready.AlphaFoldGenes_p afg
            WHERE ga.source_id = afg.gene_source_id
            AND (ga.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          )
          -- end filter query
          SELECT DISTINCT term
            , parentTerm
            , string_agg(org_abbrev, ', ') AS internal
          FROM apidbtuning.organismtree ot
            , FilterQuery fq
          WHERE ot.organism = fq.organism
          GROUP BY term, parentTerm
          ORDER BY parentTerm, term
          ]]>
      </sql>
    </sqlQuery>


  <sqlQuery name="WithSingleCell" includeProjects="TriTrypDB,PlasmoDB,PiroplasmaDB,ToxoDB,CryptoDB,HostDB,UniDB" isCacheable="true">
    <column name="internal"/>
    <column name="term"/>

      <sql>
        <![CDATA[
        SELECT DISTINCT ga.organism as term
          , ga.org_abbrev as internal
        FROM apidbtuning.GeneAttributes ga
          , apidb.cellxgene cxg
        WHERE cxg.na_feature_id = ga.na_feature_id
        AND (ga.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
      ]]>
      </sql>
    </sqlQuery>



    <sqlQuery name="withCellularLocImages" includeProjects="GiardiaDB,TriTrypDB,UniDB" isCacheable="true">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
        SELECT distinct ta.organism as term, ta.org_abbrev as internal
        FROM apidbtuning.TranscriptAttributes ta, webready.GoTermSummary_p gs
        WHERE gs.source in ('TrypTag', 'DawsonLab')
          AND ta.aa_sequence_id = gs.aa_sequence_id
          AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
        GROUP BY ta.taxon_id, ta.organism
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="OrgsWithNonNuclearGenes" includeProjects="AmoebaDB,PlasmoDB,ToxoDB,FungiDB,HostDB,PiroplasmaDB,VectorBase,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT distinct ga.organism as term, ga.org_abbrev as internal
          FROM  apidbtuning.GeneAttributes ga, apidbtuning.GenomicSeqAttributes sa, SRes.ontologyTerm ot
          WHERE ga.na_sequence_id = sa.na_sequence_id
            AND sa.so_id = ot.source_id
            AND ot.name in  ('mitochondrial_chromosome', 'apicoplast_chromosome')
            AND (ga.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
          ORDER BY ga.organism
	    ]]>
      </sql>
    </sqlQuery>



    <sqlQuery name="OrgsWithCentromereGenes" includeProjects="PlasmoDB,ToxoDB,TriTrypDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT distinct ta.organism  as term, ta.org_abbrev as internal
          FROM webready.TranscriptCenDistance_p tcd, apidbtuning.TranscriptAttributes ta
          WHERE tcd.transcript = ta.source_id
            AND (ta.project_id = '@PROJECT_ID@' OR 'UniDB' = '@PROJECT_ID@')
	      ORDER BY ta.organism
	    ]]>
      </sql>
    </sqlQuery>



    <sqlQuery name="OrgsWithHagaiPathways" includeProjects="PlasmoDB,ToxoDB,UniDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
        <![CDATA[
          SELECT DISTINCT tn.name  as term, o.abbrev  as internal
          FROM apidb.dataSource ds, sres.taxonName tn, apidb.organism o
          WHERE ds.name IN ('pfal3D7_dbxref_simple_gene2HagaiPathway_RSRC','tgonME49_dbxref_protein2Pathways_Feng_RSRC')
            AND ds.taxon_id = tn.taxon_id
            AND tn.name_class = 'scientific name'
	    and o.taxon_id = tn.taxon_id
        ]]>
      </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
